<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Admin - Doch√°zka</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.8/index.global.min.css" rel="stylesheet">
  <style>
    #calendar {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      padding: 20px;
      margin-top: 20px;
    }
    .bg-place-benecko {
      background-color: #ffcccb;
      color: black;
    }
    .bg-place-n√°chod {
      background-color: #cce5ff;
      color: black;
    }
    .bg-place-poustevna {
      background-color: #d4edda;
      color: black;
    }
    .bg-place-trutnov {
      background-color: #f3e5f5;
      color: black;
    }
    .bg-place-hospoda {
      background-color: #c146c1;
      color: black;
    }
    .bg-place-nezad√°no {
      background-color: #e0e0e0;
      color: black;
    }
    .fc-event-pending {
      background-color: orange !important;
      border: none;
    }
    .fc-event-approved {
      background-color: lightgreen !important;
      border: none;
    }
    .fc-event-paid {
      background-color: darkgreen !important;
      border: none;
    }
    .view-toggle {
      margin-top: 20px;
    }
    .active-view-btn {
      font-weight: bold;
    }
    .badge-status {
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.9em;
    }
    .status-pending {
      background-color: orange;
      color: white;
    }
    .status-approved {
      background-color: lightgreen;
    }
    .status-paid {
      background-color: darkgreen;
      color: white;
    }
    .btn-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 6px;
    }
    .form-time-group {
      display: flex;
      gap: 8px;
    }
    .bg-place-benecko,
    .bg-place-n√°chod,
    .bg-place-poustevna,
    .bg-place-trutnov,
    .bg-place-nezad√°no {
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.9em;
      display: inline-block;
    }
    .sort-icon {
      font-size: 0.8em;
      margin-left: 5px;
    }
    .text-underline {
      text-decoration: underline;
    }

  </style>
  
</head>
<body class="bg-light">
  <div class="container pt-3">
    <div class="d-flex justify-content-start gap-2">
      <a href="{{ url_for('admin_dashboard') }}" class="btn btn-sm btn-secondary">‚¨Ö Zpƒõt</a>
      <a href="{{ url_for('admin_dashboard') }}" class="btn btn-sm btn-outline-primary">üè† Dom≈Ø</a>
    </div>

    <div class="view-toggle d-flex gap-2"> 
      <button id="calendarViewBtn" class="btn btn-outline-primary active-view-btn">Kalend√°≈ô</button>
      <button id="tableViewBtn" class="btn btn-outline-primary">Tabulka</button>
      <button class="btn btn-success btn-sm" onclick="openAddModal()">+ P≈ôidat doch√°zku</button>
    </div>

    <div id="calendarContainer" class="mt-4">
      <h2>P≈ôehled doch√°zky (kalend√°≈ô)</h2>
      <div class="row g-2 mb-3">
        <div class="col-md-4">
          <select class="form-select" id="calendarEmployeeFilter">
            <option value="">V≈°ichni zamƒõstnanci</option>
          </select>

          <div class="d-flex align-items-center gap-2 mt-3">
            <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#advancedFilterModal">
              Roz≈°√≠≈ôen√Ω filtr
            </button>
            <button id="cancelAdvancedFilterBtn" class="btn btn-outline-danger btn-sm" style="display: none;">
              Zru≈°it roz≈°√≠≈ôen√Ω filtr
            </button>
          </div>

        </div>
        <div class="col-md-4">
          <select class="form-select" id="calendarPlaceFilter">
            
            <option value="">V≈°echna m√≠sta</option>
          </select>
        </div>
      </div>
      <div id="calendar"></div>
    </div>

    <div id="tableContainer" class="mt-4" style="display: none;">
      <h2>P≈ôehled doch√°zky (tabulka)</h2>
      <div class="table-responsive">
        <div class="row g-2 mb-3">
          <div class="col-md-4">
            <select class="form-select" id="placeFilter">
              <option value="">V≈°echna m√≠sta</option>
            </select>
          </div>
          <div class="col-md-4">
            <select class="form-select" id="employeeFilter">
              <option value="">V≈°ichni zamƒõstnanci</option>
            </select>
          </div>
          <div class="col-md-4">
            <select class="form-select" id="monthFilter">
              <option value="">V≈°echny mƒõs√≠ce</option>
            </select>
          </div>
        </div>
        <table id="dochazkaTable" class="table table-bordered table-hover">
          <thead class="table-light">
            <tr>
              <th onclick="sortTable(0, this)">Datum <span class="sort-icon"></span></th>
              <th onclick="sortTable(1, this)">Zamƒõstnanec <span class="sort-icon"></span></th>
              <th onclick="sortTable(2, this)">P≈ô√≠chod <span class="sort-icon"></span></th>
              <th onclick="sortTable(3, this)">Odchod <span class="sort-icon"></span></th>
              <th onclick="sortTable(4, this)">Poƒçet hodin <span class="sort-icon"></span></th>
              <th onclick="sortTable(5, this)">M√≠sto <span class="sort-icon"></span></th>
              <th>Pozn√°mka</th>
              <th onclick="sortTable(7, this)">Stav <span class="sort-icon"></span></th>
              <th>Akce</th>
            </tr>
          </thead>
          <tbody id="attendanceTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- MODAL NA √öPRAVU -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Upravit doch√°zku</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <input type="hidden" id="editDate">
            <input type="hidden" id="editUsername">

            <div class="mb-3">
              <label for="editInTime" class="form-label">P≈ô√≠chod</label>
              <input type="time" class="form-control" id="editInTime">
            </div>

            <div class="mb-3">
              <label for="editOutTime" class="form-label">Odchod</label>
              <input type="time" class="form-control" id="editOutTime">
            </div>

            <div class="mb-3">
              <label for="editStatus" class="form-label">Stav</label>
              <select class="form-select" id="editStatus">
                <option value="ƒåek√° na schv√°len√≠">ƒåek√° na schv√°len√≠</option>
                <option value="Schv√°leno">Schv√°leno</option>
                <option value="Proplaceno">Proplaceno</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="editPlace" class="form-label">M√≠sto</label>
              <input type="text" class="form-control" id="editPlace">
            </div>

            <div class="mb-3">
              <label for="editNote" class="form-label">Pozn√°mka</label>
              <textarea class="form-control" id="editNote" rows="2"></textarea>
            </div>

            <div class="d-flex justify-content-between">
              <button type="submit" class="btn btn-success">Ulo≈æit zmƒõny</button>
              <button type="button" class="btn btn-danger" id="deleteRecordBtn">Smazat</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.8/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let DOCHAZKA = [];

    async function loadDochazka() {
      console.log(DOCHAZKA);  // pomocn√© ladƒõn√≠
      const res = await fetch('/api/admin_dochazka');
      DOCHAZKA = await res.json();
      populateFilters();
      populateAdvancedFilter();


      const countsByStatus = {};

      const selectedEmp = document.getElementById('calendarEmployeeFilter').value;
      const selectedPlace = document.getElementById('calendarPlaceFilter').value;

      for (let r of DOCHAZKA) {
        const fullName = `${r.first_name || ''} ${r.last_name || ''}`.trim();

        if (
          (!selectedEmp || fullName === selectedEmp) &&
          (!selectedPlace || (r.place || 'nezad√°no') === selectedPlace)
        ) {
          const key = r.date + '_' + r.status;
          countsByStatus[key] = (countsByStatus[key] || 0) + 1;
        }
      }


      const events = [];
      for (const key in countsByStatus) {
        const [date, status] = key.split('_');
        let backgroundColor;
        let titleText;

        if (status === 'ƒåek√° na schv√°len√≠') {
          backgroundColor = 'orange';
          titleText = `${countsByStatus[key]} ƒçek√° na schv√°len√≠`;
        } else if (status === 'Schv√°leno') {
          backgroundColor = '#90ee90';
          titleText = `${countsByStatus[key]} schv√°leno`;
        } else if (status === 'Proplaceno') {
          backgroundColor = 'darkgreen';
          titleText = `${countsByStatus[key]} proplaceno`;
        }

        events.push({
          title: titleText,
          start: date,
          allDay: true,
          backgroundColor,
          borderColor: 'transparent',
          textColor: status === 'Schv√°leno' ? 'black' : ''
        });
      }

      calendar.removeAllEventSources();
      calendar.addEventSource(events);

      renderTable();
    }

    // Funkce pro zobrazen√≠ badge se stavem
    function getStatusBadge(status) {
      if (status === 'ƒåek√° na schv√°len√≠') return '<span class="badge-status status-pending">' + status + '</span>';
      if (status === 'Schv√°leno') return '<span class="badge-status status-approved">' + status + '</span>';
      if (status === 'Proplaceno') return '<span class="badge-status status-paid">' + status + '</span>';
      return status;
    }
    
    // Funkce pro vykreslen√≠ tabulky
    function renderTable() {
      const tbody = document.getElementById('attendanceTableBody');
      const selectedPlace = document.getElementById('placeFilter').value;
      const selectedEmployee = document.getElementById('employeeFilter').value;
      const selectedMonth = document.getElementById('monthFilter').value;

      tbody.innerHTML = '';

      for (let r of DOCHAZKA) {
        const fullName = `${r.first_name || ''} ${r.last_name || ''}`.trim();
        if (
          (!selectedPlace || (r.place || 'nezad√°no') === selectedPlace) &&
          (!selectedEmployee || fullName === selectedEmployee) &&
          (!selectedMonth || r.date.startsWith(selectedMonth))
        ) {
          tbody.innerHTML += `<tr>
            <td>${r.date}</td>
            <td>${fullName}</td>
            <td>${r.in_time}</td>
            <td>${r.out_time}</td>
            <td>${r.hours}</td>
            <td><span class="badge-status bg-place-${(r.place || 'nezad√°no').toLowerCase()}">${r.place || '-'}</span></td>
            <td class="text-muted small">
              ${
                r.note
                  ? `<a href="#" class="text-decoration-none text-dark" onclick="showFullNote(\`${r.note.replace(/`/g, '\\`')}\`); return false;">
                      <i class="bi bi-chat-left-text me-1"></i>${r.note.substring(0, 40)}${r.note.length > 40 ? '‚Ä¶' : ''}
                    </a>`
                  : '<span class="text-muted"> </span>'
              }
            </td>
            <td>${getStatusBadge(r.status)}</td>
            <td class="btn-actions">
              <button class="btn btn-sm btn-outline-primary" onclick="openEditModal('${r.date}', '${r.username}', '${r.in_time}', '${r.out_time}', '${r.status}', \`${r.place || ''}\`, \`${r.note || ''}\`)">Upravit</button>
              <button class="btn btn-sm btn-outline-success" onclick="approve('${r.date}', '${r.username}')">Schv√°lit</button>
            </td>
          </tr>`;
        }
      }
    }

    let currentSortColumn = null;
    let currentSortDirection = 'asc';

    function sortTable(colIndex, thElement) {
  const rows = Array.from(document.querySelectorAll('#attendanceTableBody tr'));
  const isSameColumn = currentSortColumn === colIndex;

  currentSortDirection = isSameColumn && currentSortDirection === 'asc' ? 'desc' : 'asc';
  currentSortColumn = colIndex;

  rows.sort((a, b) => {
    let valA = a.cells[colIndex].innerText.trim();
    let valB = b.cells[colIndex].innerText.trim();

    // Speci√°ln√≠ ≈ôazen√≠ pro datum (sloupec 0)
    if (colIndex === 0) {
      const dateA = new Date(valA);
      const dateB = new Date(valB);
      return currentSortDirection === 'asc' ? dateA - dateB : dateB - dateA;
    }

    // zkus√≠me ≈ôadit ƒç√≠selnƒõ, jinak jako text
    const numA = parseFloat(valA.replace(',', '.'));
    const numB = parseFloat(valB.replace(',', '.'));

    if (!isNaN(numA) && !isNaN(numB)) {
      return currentSortDirection === 'asc' ? numA - numB : numB - numA;
    } else {
      return currentSortDirection === 'asc'
        ? valA.localeCompare(valB)
        : valB.localeCompare(valA);
    }
  });

  const tbody = document.getElementById('attendanceTableBody');
  tbody.innerHTML = '';
  rows.forEach(row => tbody.appendChild(row));

      // Reset ikon
      document.querySelectorAll('th .sort-icon').forEach(el => el.innerHTML = '');
      document.querySelectorAll('th').forEach(el => el.classList.remove('text-underline'));

      // P≈ôid√°n√≠ ≈°ipky a podtr≈æen√≠
      if (thElement) {
        const icon = thElement.querySelector('.sort-icon');
        icon.innerHTML = currentSortDirection === 'asc' ? '‚ñ≤' : '‚ñº';
        thElement.classList.add('text-underline');
      }
    }


    // Funkce pro naplnƒõn√≠ filtr≈Ø
    function populateFilters() {
      const employeeSet = new Set();
      const placeSet = new Set();
      const monthSet = new Set();

      for (const r of DOCHAZKA) {
        const fullName = `${r.first_name || ''} ${r.last_name || ''}`.trim();
        employeeSet.add(fullName);
        placeSet.add(r.place || 'nezad√°no');
        monthSet.add(r.date.substring(0, 7)); // YYYY-MM
      }

      // Ulo≈æ aktu√°ln√≠ v√Ωbƒõry
      const currentEmp = document.getElementById('calendarEmployeeFilter').value;
      const currentPlace = document.getElementById('calendarPlaceFilter').value;

      // Kalend√°≈ô ‚Äì zamƒõstnanci
      const calendarEmployeeFilter = document.getElementById('calendarEmployeeFilter');
      calendarEmployeeFilter.innerHTML = '<option value="">V≈°ichni zamƒõstnanci</option>' +
        [...employeeSet].sort().map(e => `<option value="${e}">${e}</option>`).join('');
      calendarEmployeeFilter.value = currentEmp;

      // Kalend√°≈ô ‚Äì m√≠sta
      const calendarPlaceFilter = document.getElementById('calendarPlaceFilter');
      calendarPlaceFilter.innerHTML = '<option value="">V≈°echna m√≠sta</option>' +
        [...placeSet].sort().map(p => `<option value="${p}">${p}</option>`).join('');
      calendarPlaceFilter.value = currentPlace;

      // Tabulka ‚Äì zamƒõstnanci
      const employeeFilter = document.getElementById('employeeFilter');
      employeeFilter.innerHTML = '<option value="">V≈°ichni zamƒõstnanci</option>' +
        [...employeeSet].sort().map(e => `<option value="${e}">${e}</option>`).join('');

      // Tabulka ‚Äì m√≠sta
      const placeFilter = document.getElementById('placeFilter');
      placeFilter.innerHTML = '<option value="">V≈°echna m√≠sta</option>' +
        [...placeSet].sort().map(p => `<option value="${p}">${p}</option>`).join('');

      // Tabulka ‚Äì mƒõs√≠ce
      const monthFilter = document.getElementById('monthFilter');
      monthFilter.innerHTML = '<option value="">V≈°echny mƒõs√≠ce</option>' +
        [...monthSet].sort().map(m => `<option value="${m}">${m}</option>`).join('');
    }



    // Funkce pro otev≈ôen√≠ mod√°ln√≠ho okna pro √∫pravu
    function openEditModal(date, username, in_time, out_time, status, place = '', note = '', z_kalendare = false) {
      document.getElementById('editDate').value = date;
      document.getElementById('editUsername').value = username;
      document.getElementById('editInTime').value = in_time;
      document.getElementById('editOutTime').value = out_time;
      document.getElementById('editStatus').value = status;
      document.getElementById('editPlace').value = place;
      document.getElementById('editNote').value = note;
      const modal = new bootstrap.Modal(document.getElementById('editModal'));
      modal.show();

      const detailModalEl = document.getElementById('detailModal');
      const detailModal = bootstrap.Modal.getOrCreateInstance(detailModalEl);
      detailModal.hide();  // Skryje mod√°ln√≠ okno detailu dne

      if (z_kalendare) {
        // Po zav≈ôen√≠ editace se znovu otev≈ôe detail dne (jen pokud p≈ôich√°z√≠ z kalend√°≈ôe)
        document.getElementById('editModal').addEventListener('hidden.bs.modal', function reopenDetailModal() {
          detailModal.show();
          this.removeEventListener('hidden.bs.modal', reopenDetailModal);
        });
      }
    }

    document.getElementById('editForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const date = document.getElementById('editDate').value;
      const username = document.getElementById('editUsername').value;
      const in_time = document.getElementById('editInTime').value;
      const out_time = document.getElementById('editOutTime').value;
      const status = document.getElementById('editStatus').value;
      const place = document.getElementById('editPlace').value;
      const note = document.getElementById('editNote').value;

      await fetch('/api/update_time', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date, username, in_time, out_time, place, note })
      });

      await fetch('/api/zmenit_stav', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date, username, status })
      });
      bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
      await loadDochazka();
      const clickInfo = { dateStr: date };
      calendar.getOption('dateClick')(clickInfo);
    });

    document.getElementById('deleteRecordBtn').addEventListener('click', async function() {
      const date = document.getElementById('editDate').value;
      const username = document.getElementById('editUsername').value;
      if (confirm('Opravdu chcete tento z√°znam smazat?')) {
        await fetch('/api/smazat_zaznam', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date, username })
        });
        bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
        await loadDochazka();
        const clickInfo = { dateStr: date };
      calendar.getOption('dateClick')(clickInfo);
      }
    });

    async function approve(date, username) {
      const record = DOCHAZKA.find(r => r.date === date && r.username === username);
      if (record && record.status === 'Proplaceno') {
        alert('Tento z√°znam je ji≈æ oznaƒçen jako proplacen√Ω a nelze ho znovu schv√°lit.');
        return;
      }

      await fetch('/api/schvalit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date, username })
      });
      await loadDochazka();
      const clickInfo = { dateStr: date };
      calendar.getOption('dateClick')(clickInfo);
    }


    async function approveAll(date) {
      await fetch('/api/schvalit_den', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date })
      });
      await loadDochazka();
      // Otev≈ôi znovu modal s aktualizovan√Ωm obsahem
      const clickInfo = { dateStr: date };
      calendar.getOption('dateClick')(clickInfo);
    }


    let calendar;
    document.addEventListener('DOMContentLoaded', async function () {
      populateAdvancedFilter();

      calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        initialView: 'dayGridMonth',
        locale: 'cs',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: ''
        },
        
        dateClick: function(info) {
          const records = DOCHAZKA.filter(r => r.date === info.dateStr);
          let html = '<ul class="list-group">';
          for (let r of records) {
            const fullName = `${r.first_name || ''} ${r.last_name || ''}`.trim();
            html += `<li class="list-group-item">
              <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div>
                  <strong>${fullName}</strong> ${r.in_time} - ${r.out_time} (${r.hours} h)
                  <span class="badge-status bg-place-${(r.place || 'nezad√°no').toLowerCase()} ms-2">${r.place || '-'}</span>
                </div>
                <div class="note-preview text-end text-muted small" style="max-width: 40%;">
                  ${r.note
                    ? `<a href="#" class="text-decoration-none text-dark" onclick="showFullNote(\`${r.note.replace(/`/g, '\\`')}\`); return false;">
                        <i class="bi bi-chat-left-text me-1"></i>${r.note.substring(0, 50)}${r.note.length > 50 ? '‚Ä¶' : ''}
                      </a>`
                    : '<span class="text-muted">bez pozn√°mky</span>'}
                </div>
                
              </div>
              

              <div class="btn-actions mt-1">
                ${getStatusBadge(r.status)}
                <button class="btn btn-sm btn-outline-primary" onclick="openEditModal('${r.date}', '${r.username}', '${r.in_time}', '${r.out_time}', '${r.status}', \`${r.place || ''}\`, \`${r.note || ''}\`)">Upravit</button>
                <button class="btn btn-sm btn-outline-success" onclick="approve('${r.date}', '${r.username}')">Schv√°lit</button>
              </div>
            </li>`;

          }
          html += '</ul><hr><button class="btn btn-success" onclick="approveAll(\'' + info.dateStr + '\')">Schv√°lit cel√Ω den</button>';
          document.getElementById('modalContent').innerHTML = html;
          const detailModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('detailModal'));
          detailModal.show();

          // Schovej detailModal p≈ôi otev≈ôen√≠ editace
          document.querySelectorAll('#modalContent .btn-outline-primary').forEach(btn => {
            btn.addEventListener('click', () => {
              detailModal.hide();
            });
          });

        }
      });

      calendar.render();
      await loadDochazka();

      document.getElementById('calendarViewBtn').addEventListener('click', () => {
        document.getElementById('calendarContainer').style.display = 'block';
        document.getElementById('tableContainer').style.display = 'none';
        document.getElementById('calendarViewBtn').classList.add('active-view-btn');
        document.getElementById('tableViewBtn').classList.remove('active-view-btn');
      });

      document.getElementById('tableViewBtn').addEventListener('click', () => {
        document.getElementById('calendarContainer').style.display = 'none';
        document.getElementById('tableContainer').style.display = 'block';
        document.getElementById('calendarViewBtn').classList.remove('active-view-btn');
        document.getElementById('tableViewBtn').classList.add('active-view-btn');
      });

      // Inicializace DataTable po zmƒõnƒõ filtr≈Ø
      document.getElementById('employeeFilter').addEventListener('change', renderTable);
      document.getElementById('monthFilter').addEventListener('change', renderTable);
      document.getElementById('placeFilter').addEventListener('change', renderTable);
      document.getElementById('calendarEmployeeFilter').addEventListener('change', loadDochazka);
      document.getElementById('calendarPlaceFilter').addEventListener('change', loadDochazka);

    });

    // Funkce na zobrazen√≠ cel√© pozn√°mky
    function showFullNote(note) {
      document.getElementById('noteModalBody').innerText = note || '(bez pozn√°mky)';
      const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('noteModal'));
      modal.show();
    }


  </script>

  <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Z√°znamy dne</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zav≈ô√≠t"></button>
        </div>
        <div class="modal-body" id="modalContent">
          <!-- dynamicky doplnƒõno -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal na zobrazen√≠ cel√© pozn√°mky -->
  <div class="modal fade" id="noteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Cel√° pozn√°mka</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zav≈ô√≠t"></button>
        </div>
        <div class="modal-body" id="noteModalBody"></div>
      </div>
    </div>
  </div>

<!-- Modal pro p≈ôid√°n√≠ nov√© doch√°zky -->
<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="addForm" onsubmit="event.preventDefault(); submitAddForm();">
        <div class="modal-header">
          <h5 class="modal-title" id="addModalLabel">Vytvo≈ôit doch√°zku</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zav≈ô√≠t"></button>
        </div>
        <div class="modal-body">

          <!-- Vyhled√°v√°n√≠ zamƒõstnance -->
          <div class="mb-3 position-relative">
            <label for="addUsernameInput" class="form-label">Zamƒõstnanec</label>
            <input type="text" class="form-control" id="addUsernameInput" placeholder="Zaƒçni ps√°t jm√©no..." autocomplete="off" required>
            <div id="userSuggestions" class="list-group position-absolute w-100" style="z-index: 1050;"></div>
            <input type="hidden" id="addUsername">
          </div>

          <!-- Datum -->
          <div class="mb-3">
            <label for="addDate" class="form-label">Datum</label>
            <input type="date" class="form-control" id="addDate" required>
          </div>

          <!-- P≈ô√≠chod -->
          <div class="mb-3">
            <label for="addInTime" class="form-label">P≈ô√≠chod</label>
            <input type="time" class="form-control" id="addInTime" required>
          </div>

          <!-- Odchod -->
          <div class="mb-3">
            <label for="addOutTime" class="form-label">Odchod</label>
            <input type="time" class="form-control" id="addOutTime" required>
          </div>

          <!-- M√≠sto -->
          <div class="mb-3">
            <label for="addPlace" class="form-label">M√≠sto</label>
            <input type="text" class="form-control" id="addPlace">
          </div>

          <!-- Pozn√°mka -->
          <div class="mb-3">
            <label for="addNote" class="form-label">Pozn√°mka</label>
            <textarea class="form-control" id="addNote" rows="2"></textarea>
          </div>

        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Ulo≈æit</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal pro roz≈°√≠≈ôen√Ω filtr v kalend√°≈ôi -->
<div class="modal fade" id="advancedFilterModal" tabindex="-1" aria-labelledby="advancedFilterModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="advancedFilterModalLabel">Roz≈°√≠≈ôen√Ω filtr</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zav≈ô√≠t"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- Zamƒõstnanci -->
          <div class="col-md-6">
            <input type="text" class="form-control mb-2" placeholder="Vyhledat zamƒõstnance..." oninput="filterList('employeeCheckboxes', this.value)">
            <button type="button" class="btn btn-sm btn-outline-primary mt-2 mb-2" onclick="selectAll('employeeCheckboxes')">Oznaƒçit v≈°echny zamƒõstnance</button>
            <div id="employeeCheckboxes" class="form-check overflow-auto border p-2" style="max-height: 300px;"></div>
          </div>

          <!-- M√≠sta -->
          <div class="col-md-6">
            <input type="text" class="form-control mb-2" placeholder="Vyhledat m√≠sto..." oninput="filterList('placeCheckboxes', this.value)">
            <button type="button" class="btn btn-sm btn-outline-primary mt-2 mb-2" onclick="selectAll('placeCheckboxes')">Oznaƒçit v≈°echna m√≠sta</button>
            <div id="placeCheckboxes" class="form-check overflow-auto border p-2" style="max-height: 300px;"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Zav≈ô√≠t</button>
        <button class="btn btn-primary" onclick="applyAdvancedFilter()">Pou≈æ√≠t filtr</button>
      </div>
    </div>
  </div>
</div>


<script>
let allUsers = [];

window.openAddModal = async function () {
  // Reset formul√°≈ôe a p≈ôiprav modal
  document.getElementById('addForm').reset();
  document.getElementById('userSuggestions').innerHTML = '';
  document.getElementById('addUsername').value = '';

  // Otev≈ôe Bootstrap modal
  new bootstrap.Modal(document.getElementById('addModal')).show();

  // Naƒçti seznam u≈æivatel≈Ø (pokud je≈°tƒõ nen√≠ naƒçten√Ω)
  if (allUsers.length === 0) {
    const res = await fetch('/api/seznam_zamestnancu');
    allUsers = await res.json();
  }

  // Znovu p≈ôid√°n√≠ event listeneru na input (aby fungovalo autocomplete poka≈æd√©)
  const input = document.getElementById('addUsernameInput');
  const newInput = input.cloneNode(true);
  input.parentNode.replaceChild(newInput, input);

  newInput.addEventListener('input', function () {
    const value = this.value.toLowerCase();
    const suggestions = document.getElementById('userSuggestions');
    suggestions.innerHTML = '';

    if (value.length < 2) return;

    const matches = allUsers.filter(u =>
      `${u.first_name} ${u.last_name}`.toLowerCase().includes(value)
    );

    matches.forEach(u => {
      const item = document.createElement('button');
      item.className = 'list-group-item list-group-item-action';
      item.textContent = `${u.first_name} ${u.last_name}`;
      item.onclick = function () {
        newInput.value = `${u.first_name} ${u.last_name}`;
        document.getElementById('addUsername').value = u.username;
        suggestions.innerHTML = '';
      };
      suggestions.appendChild(item);
    });
  });
}
</script>


</body>
<script>

const STATUS_COLORS = {
  'ƒåek√° na schv√°len√≠': 'orange',
  'Schv√°leno': 'lightgreen',
  'Proplaceno': 'darkgreen'
};


function populateAdvancedFilter() {
  const empSet = new Set();
  const placeSet = new Set();

  for (const r of DOCHAZKA) {
    empSet.add(`${r.first_name || ''} ${r.last_name || ''}`.trim());
    placeSet.add(r.place || 'nezad√°no');
  }

  const empDiv = document.getElementById('employeeCheckboxes');
  empDiv.innerHTML = [...empSet].sort().map((e, i) =>
    `<div class="form-check">
      <input class="form-check-input" type="checkbox" value="${e}" id="emp_${i}">
      <label class="form-check-label" for="emp_${i}">${e}</label>
    </div>`
  ).join('');


  const placeDiv = document.getElementById('placeCheckboxes');
  placeDiv.innerHTML = [...placeSet].sort().map((p, i) =>
    `<div class="form-check">
      <input class="form-check-input" type="checkbox" value="${p}" id="place_${i}">
      <label class="form-check-label" for="place_${i}">${p}</label>
    </div>`
  ).join('');
}

// Textov√© vyhled√°v√°n√≠ ve filtrech
function filterList(containerId, query) {
  const items = document.querySelectorAll(`#${containerId} div`);
  query = query.toLowerCase();
  items.forEach(item => {
    const text = item.textContent.toLowerCase();
    item.style.display = text.includes(query) ? '' : 'none';
  });
}

// Aplikace roz≈°√≠≈ôen√©ho filtru
function applyAdvancedFilter() {

  const selectedEmployees = [...document.querySelectorAll('#employeeCheckboxes input:checked')].map(i => i.value);
  const selectedPlaces = [...document.querySelectorAll('#placeCheckboxes input:checked')].map(i => i.value);

  console.log("Spou≈°t√≠m applyAdvancedFilter");
  console.log("Vybran√≠ zamƒõstnanci:", selectedEmployees);
  console.log("Vybran√° m√≠sta:", selectedPlaces);
  console.log("Doch√°zka:", DOCHAZKA);

  // üßπ Reset klasick√©ho filtru (selecty)
  const basicEmployeeSelect = document.getElementById('employeeSelect');
    if (basicEmployeeSelect) basicEmployeeSelect.value = '';

  const basicPlaceSelect = document.getElementById('placeSelect');
    if (basicPlaceSelect) basicPlaceSelect.value = '';


  const countsByStatus = {};

  for (let r of DOCHAZKA) {
    const fullName = `${r.first_name || ''} ${r.last_name || ''}`.trim();
    const place = r.place || 'nezad√°no';

    if (
      (selectedEmployees.length === 0 || selectedEmployees.includes(fullName)) &&
      (selectedPlaces.length === 0 || selectedPlaces.includes(place))
    ) {
      const key = r.date + '_' + r.status;
      countsByStatus[key] = (countsByStatus[key] || 0) + 1;
    }
  }

  calendar.removeAllEvents();

  for (const key in countsByStatus) {
    const [date, status] = key.split('_');
    const count = countsByStatus[key];
    const color = STATUS_COLORS[status] || 'gray';

    calendar.addEvent({
      title: `${count}x ${status}`,
      start: date,
      allDay: true,
      backgroundColor: color,
      borderColor: color
    });
  }

  const modal = bootstrap.Modal.getInstance(document.getElementById('advancedFilterModal'));
  modal.hide();
  document.getElementById('cancelAdvancedFilterBtn').style.display = 'inline-block';
}

// Funkce pro zru≈°en√≠ roz≈°√≠≈ôen√©ho filtru - znovu naƒçte str√°nku
document.getElementById('cancelAdvancedFilterBtn').addEventListener('click', () => {
  location.reload();
});

// Funkce pro oznaƒçen√≠ v≈°ech checkbox≈Ø v dan√©m kontejneru
function selectAll(containerId) {
  const checkboxes = document.querySelectorAll(`#${containerId} input[type="checkbox"]`);
  const allChecked = [...checkboxes].every(cb => cb.checked);

  checkboxes.forEach(cb => cb.checked = !allChecked);
}



document.addEventListener("DOMContentLoaded", function () {
  // üîç Vyhled√°v√°n√≠ zamƒõstnanc≈Ø podle jm√©na
  
  // ‚úÖ Odesl√°n√≠ formul√°≈ôe
  document.getElementById("addForm").addEventListener("submit", function (e) {
    e.preventDefault();
    submitForm();
  });

  // üåü Funkce pro odesl√°n√≠ dat
  window.submitForm = function () {
    const payload = {
      username: document.getElementById('addUsername').value,
      date: document.getElementById('addDate').value,
      in_time: document.getElementById('addInTime').value,
      out_time: document.getElementById('addOutTime').value,
      place: document.getElementById('addPlace').value,
      note: document.getElementById('addNote').value,
    };

    fetch('/api/pridat_dochazku_admin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    })
      .then(response => {
        if (!response.ok) throw new Error("Chyba p≈ôi odes√≠l√°n√≠ formul√°≈ôe.");
        return response.json();
      })
      .then(data => {
        if (data.success) {
          location.reload();  // üîÑ Refresh str√°nky
        } else {
          alert("Nepoda≈ôilo se ulo≈æit doch√°zku.");
        }
      })
      .catch(err => {
        console.error(err);
        alert("Nastala chyba p≈ôi odes√≠l√°n√≠.");
      });
  };
});

// Funkce pro aktualizaci kalend√°≈ôe s daty
function updateCalendar(data) {
  calendar.removeAllEvents();

  const countsByStatus = {};
  for (let r of data) {
    const key = r.date + '_' + r.status;
    countsByStatus[key] = (countsByStatus[key] || 0) + 1;
  }

  for (const key in countsByStatus) {
    const [date, status] = key.split('_');
    const count = countsByStatus[key];
    const color = STATUS_COLORS[status] || 'gray';

    calendar.addEvent({
      title: `${count}x ${status}`,
      start: date,
      allDay: true,
      backgroundColor: color,
      borderColor: color
    });
  }
}

</script>


</html>
