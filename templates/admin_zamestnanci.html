<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Admin ‚Äì Zamƒõstnanci</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <style>
    #attendanceTable td {
      vertical-align: middle;
      white-space: nowrap;
    }

    #attendanceTable td:nth-child(6) {
      max-width: 180px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    a.note-icon {
      text-decoration: none;
      font-size: 1em;
      margin-left: 5px;
      cursor: pointer;
    }

    .badge-status {
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.9em;
    }
    .status-pending { background-color: orange; color: white; }
    .status-approved { background-color: lightgreen; }
    .status-paid { background-color: darkgreen; color: white; }
    .typ-brigadnik { background-color: purple; color: white; padding: 4px 8px; border-radius: 6px; }
    .typ-kopac { background-color: darkcyan; color: white; padding: 4px 8px; border-radius: 6px; }
    .profile-box {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      background: #fff;
    }
    .badge-status {
      padding: 4px 8px;
      border-radius: 0.4rem;
      font-size: 0.85em;
      font-weight: 500;
    }
    .bg-place-benecko {
      background-color: #ffcccb;
      color: black;
    }
    .bg-place-n√°chod {
      background-color: #cce5ff;
      color: black;
    }
    .bg-place-poustevna {
      background-color: #d4edda;
      color: black;
    }
    .bg-place-trutnov {
      background-color: #f3e5f5;
      color: black; 
    }
    .bg-place-hospoda {
      background-color: #c146c1;
      color: black;
    }
    .bg-place-nezad√°no {
      background-color: #e0e0e0;
      color: black;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex justify-content-start gap-2 mb-3">
      <a href="{{ url_for('admin_dashboard') }}" class="btn btn-sm btn-secondary">‚¨Ö Zpƒõt</a>
      <a href="{{ url_for('admin_dashboard') }}" class="btn btn-sm btn-outline-primary">üè† Dom≈Ø</a>
    </div>

    <h2>Seznam zamƒõstnanc≈Ø</h2>
    <table class="table table-hover table-bordered" id="employeeTable">
      <thead class="table-light">
        <tr>
          <th>Jm√©no</th>
          <th>Typ z√°vazku</th>
          <th>Stav</th>
          <th>Posledn√≠ platba</th>
          <th>Akce</th>
        </tr>
      </thead>
      <tbody>
        <!-- Dynamicky plnƒõno -->
      </tbody>
    </table>
      <div class="profile-box" id="employeeProfile" style="display: none;">
        <h3 id="profileName" class="fw-bold mb-4"></h3>
        <div class="row">
          <div class="col-md-6">
            <p><strong>IƒåO:</strong> <span id="profileIco"></span></p>
            <p><strong>Bankovn√≠ √∫ƒçet:</strong> <span id="profileBank"></span></p>
            <p><strong>Hodinovka:</strong> <span id="profileRate"></span> Kƒç/h</p>
          </div>
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body">
                <h6>Hodin ke schv√°len√≠</h6>
                <p class="fs-4 mb-2"><span id="pendingHoursBox">0</span> h</p>
                <button class="btn btn-sm btn-outline-primary" onclick="openApprovalForm()">Otev≈ô√≠t</button>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body">
                <h6>Hodin k proplacen√≠</h6>
                <p class="fs-4 mb-2"><span id="unpaidHoursBox">0</span> h</p>
                <button class="btn btn-sm btn-outline-success" onclick="openPaymentForm()">Otev≈ô√≠t</button>
              </div>
            </div>
          </div>
        </div>

        <hr>
        <div class="accordion mt-3" id="statsAccordion">
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingStats">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseStats" aria-expanded="false" aria-controls="collapseStats">
                Statistiky doch√°zky
              </button>
            </h2>
            <div id="collapseStats" class="accordion-collapse collapse" aria-labelledby="headingStats" data-bs-parent="#statsAccordion">
              <div class="accordion-body">
                <div class="row">
                  <div class="col-md-6">
                    <ul class="list-group list-group-flush">
                      <li class="list-group-item">Celkovƒõ odpracovan√© hodiny: <span id="totalHours">0</span> h</li>
                      <li class="list-group-item">Hodiny ƒçekaj√≠c√≠ na schv√°len√≠: <span class="badge bg-warning text-dark" id="pendingHours">0</span> h</li>
                      <li class="list-group-item">Hodiny ƒçekaj√≠c√≠ na zaplacen√≠: <span class="badge bg-success bg-opacity-50 text-dark" id="unpaidHours">0</span> h</li>
                      <li class="list-group-item">Hodiny za posledn√≠ch 30 dn√≠: <span class="badge bg-primary bg-opacity-50" id="last30DaysHours">0</span> h</li>
                      <li class="list-group-item">Poƒçet dn√≠ v pr√°ci za posledn√≠ch 30 dn√≠: <span id="last30DaysWorkedDays">0</span></li>
                      <li class="list-group-item">Pr≈Ømƒõr hodin na pracovn√≠ den (30 dn√≠): <span id="avgDailyHours">0</span> h</li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <!-- Sem m≈Ø≈æe≈° pozdƒõji p≈ôidat graf -->
                    <div id="attendanceChart" style="height: 250px;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="mt-4">
            <h5>Doch√°zka</h5>
            <table id="attendanceTable" class="table table-sm table-bordered align-middle text-center">

              <thead class="table-light">
                <tr>
                  <th>Datum</th>
                  <th>P≈ô√≠chod</th>
                  <th>Odchod</th>
                  <th>Poƒçet hodin</th>
                  <th>M√≠sto</th>
                  <th>Pozn√°mka</th>
                  <th>Stav</th>
                  <th>Akce</th>
                </tr>
              </thead>
              <tbody id="attendanceDetail"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

  <script>
    let employees = [];
    let selectedEmployee = null;

    async function loadEmployees() {
      try {
        const res = await fetch('/api/admin_zamestnanci');
        if (!res.ok) throw new Error('Chyba p≈ôi naƒç√≠t√°n√≠ dat');
        employees = await res.json();

        const tbody = document.querySelector('#employeeTable tbody');
        tbody.innerHTML = '';

        if (!employees.length) {
          tbody.innerHTML = '<tr><td colspan="5">≈Ω√°dn√≠ zamƒõstnanci</td></tr>';
          return;
        }

        for (let emp of employees) {
          const zavazekBadge = emp.typ_zavazku === 'Brig√°dn√≠k'
            ? '<span class="typ-brigadnik">Brig√°dn√≠k</span>'
            : '<span class="typ-kopac">St√°l√Ω kop√°ƒç</span>';

          const stav = `
            <span class="badge-status status-pending">${emp.stats?.pending_hours || 0}</span>
            <span class="badge-status status-approved">${emp.stats?.unpaid_hours || 0}</span>`;

          tbody.innerHTML += `
            <tr>
              <td>${emp.first_name} ${emp.last_name}</td>
              <td>${zavazekBadge}</td>
              <td>${stav}</td>
              <td>${emp.last_payment || '-'}</td>
              <td><button class="btn btn-sm btn-primary" onclick="showProfile('${emp.username}')">Zobrazit profil</button></td>
            </tr>`;
        }

        new DataTable('#employeeTable');
      } catch (err) {
        console.error('Chyba:', err);
        alert('Nepoda≈ôilo se naƒç√≠st seznam zamƒõstnanc≈Ø.');
      }
    }

    async function showProfile(username) {
      const res = await fetch(`/api/admin_zamestnanec/${username}`);
      const data = await res.json();
      selectedEmployee = username;

      document.getElementById('employeeProfile').style.display = 'block';
      document.getElementById('profileName').innerText = data.first_name + ' ' + data.last_name;
      document.getElementById('profileIco').innerText = data.ico;
      document.getElementById('profileBank').innerText = data.bank_account;
      document.getElementById('profileRate').innerText = data.hourly_rate;
      document.getElementById('pendingHoursBox').innerText = data.stats.pending_hours;
      document.getElementById('unpaidHoursBox').innerText = data.stats.unpaid_hours;

      document.getElementById('totalHours').innerText = data.stats.total_hours;
      document.getElementById('pendingHours').innerText = data.stats.pending_hours;
      document.getElementById('unpaidHours').innerText = data.stats.unpaid_hours;
      document.getElementById('last30DaysHours').innerText = data.stats.last_30_days_hours;
      document.getElementById('last30DaysWorkedDays').innerText = data.stats.last_30_days_days;
      document.getElementById('avgDailyHours').innerText = data.stats.avg_daily_hours;

      const tbody = document.getElementById('attendanceDetail');
      tbody.innerHTML = '';

      for (let r of data.attendance) {
        let badge = r.status === 'ƒåek√° na schv√°len√≠' ? 'status-pending' : r.status === 'Schv√°leno' ? 'status-approved' : 'status-paid';
        tbody.innerHTML += `
          <tr>
            <td>${r.date}</td>
            <td>${r.in_time}</td>
            <td>${r.out_time}</td>
            <td>${r.hours}</td>
            <td><span class="badge-status bg-place-${(r.place || 'nezad√°no').toLowerCase()}">${r.place || '-'}</span></td>
            <td class="text-muted small">
              ${
                r.note
                  ? `<a href="#" class="text-decoration-none text-dark" onclick="showFullNote(\`${r.note.replace(/`/g, '\\`')}\`); return false;">
                      <i class="bi bi-chat-left-text me-1"></i>${r.note.substring(0, 40)}${r.note.length > 40 ? '‚Ä¶' : ''}
                    </a>`
                  : '<span class="text-muted">bez pozn√°mky</span>'
              }
            </td>
            <td><span class="badge-status ${badge}">${r.status}</span></td>
            <td>
              <button class="btn btn-sm btn-outline-success" onclick="approve('${r.date}', '${selectedEmployee}')">Schv√°lit</button>
              <button class="btn btn-sm btn-outline-primary" onclick="openEditModal('${r.date}', '${r.in_time}', '${r.out_time}', '${r.status}', \`${r.place || ''}\`, \`${r.note || ''}\`)">Upravit</button>
            </td>
          </tr>`;
      }
      new DataTable('#attendanceTable');
    }

    function markAsPaid() {
      fetch(`/api/admin_zamestnanec_zaplaceno/${selectedEmployee}`, { method: 'POST' })
        .then(() => showProfile(selectedEmployee));
    }

    async function updateTime(date, username, in_time, out_time) {
      await fetch('/api/update_time', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date, username, in_time, out_time })
      });
      await showProfile(username);
    }

    async function approve(date, username) {
      const row = [...document.querySelectorAll('#attendanceDetail tr')]
        .find(r => r.children[0].innerText === date);

      const currentStatus = row?.children[4]?.innerText.trim();

      if (currentStatus === 'Proplaceno') {
        alert('Tento z√°znam je ji≈æ oznaƒçen jako proplacen√Ω a nelze ho znovu schv√°lit.');
        return;
      }

      await fetch('/api/schvalit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date, username })
      });
      await showProfile(username);
    }

    async function deleteRecord(date, username) {
      if (!confirm('Opravdu chcete smazat tento z√°znam?')) return;
      await fetch('/api/smazat_zaznam', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date, username })
      });
      await showProfile(username);
    }

    async function changeStatus(date, username, status) {
      await fetch('/api/zmenit_stav', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date, username, status })
      });
      await showProfile(username);
    }

    document.addEventListener('DOMContentLoaded', loadEmployees);

    // Funkce pro otev≈ôen√≠ mod√°ln√≠ho okna pro editaci
    let editingDate = null;
    function openEditModal(date, inTime, outTime, status, place, note) {
      console.log({date, inTime, outTime, status, place, note});  // debug
      editingDate = date;
      document.getElementById('editDate').value = date;
      document.getElementById('editInTime').value = inTime;
      document.getElementById('editOutTime').value = outTime;
      document.getElementById('editStatus').value = status;
      document.getElementById('editPlace').value = place || '';
      document.getElementById('editNote').value = note || '';
      new bootstrap.Modal(document.getElementById('editModal')).show();
    }
    
    async function saveChanges() {
      const date = document.getElementById('editDate').value;
      const in_time = document.getElementById('editInTime').value;
      const out_time = document.getElementById('editOutTime').value;
      const status = document.getElementById('editStatus').value;
      const place = document.getElementById('editPlace').value;
      const note = document.getElementById('editNote').value;

      // 1. Ulo≈æen√≠ ƒçasu, m√≠sta a pozn√°mky
      const res1 = await fetch('/api/update_time', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          username: selectedEmployee,
          date,
          in_time,
          out_time,
          place,
          note
        })
      });

      // 2. Ulo≈æen√≠ stavu
      const res2 = await fetch('/api/zmenit_stav', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          username: selectedEmployee,
          date,
          status
        })
      });

      if (res1.ok && res2.ok) {
        bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
        await showProfile(selectedEmployee); // znovu naƒçti tabulku
      } else {
        alert('Nepoda≈ôilo se ulo≈æit zmƒõny.');
        console.error('update_time response:', await res1.text());
        console.error('zmenit_stav response:', await res2.text());
      }
    }



    function confirmDelete() {
      if (!confirm('Opravdu chcete smazat tento z√°znam?')) return;
      deleteRecord(editingDate, selectedEmployee);
      bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
    }
    // Funkce pro otev≈ôen√≠ formul√°≈ôe pro schv√°len√≠ hodin
    function openApprovalForm() {
      const tbody = document.getElementById('approvalTableBody');
      tbody.innerHTML = '';

      fetch(`/api/admin_zamestnanec/${selectedEmployee}`)
        .then(res => res.json())
        .then(data => {
          const filtered = data.attendance?.filter(r => r.status === 'ƒåek√° na schv√°len√≠') || [];

          for (let r of filtered) {
            tbody.innerHTML += `
              <tr>
                <td>${r.date}</td>
                <td>${r.in_time}</td>
                <td>${r.out_time}</td>
                <td>${r.hours}</td>
                <td><span class="badge-status bg-place-${(r.place || 'nezad√°no').toLowerCase()}">${r.place || '-'}</span></td>
                <td>
                  ${
                    r.note
                      ? `<a href="#" class="text-decoration-none text-dark" onclick="showFullNote(\`${r.note.replace(/`/g, '\\`')}\`); return false;">
                          <i class="bi bi-chat-left-text me-1"></i>${r.note.substring(0, 40)}${r.note.length > 40 ? '‚Ä¶' : ''}
                        </a>`
                      : '<span class="text-muted">bez pozn√°mky</span>'
                  }
                </td>
                <td class="text-center">
                  <div class="form-check d-flex justify-content-center">
                    <input class="form-check-input approval-checkbox" type="checkbox" value="${r.date}">
                  </div>
                </td>
              </tr>`;
          }

          new bootstrap.Modal(document.getElementById('approvalModal')).show();
        });
    }
    // Funkce pro oznaƒçen√≠ v≈°ech checkbox≈Ø Approval
    function toggleAllApprovalCheckboxes() {
      const checkboxes = document.querySelectorAll('.approval-checkbox');
      const allChecked = document.getElementById('checkAllApprovals').checked;
      checkboxes.forEach(cb => cb.checked = allChecked);
    }

    async function approveSelected() {
      const selectedDates = [...document.querySelectorAll('.approval-checkbox:checked')].map(cb => cb.value);
      for (let date of selectedDates) {
        await fetch('/api/schvalit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date, username: selectedEmployee })
        });
      }
      bootstrap.Modal.getInstance(document.getElementById('approvalModal')).hide();
      await showProfile(selectedEmployee);
    }

    // Funkce pro otev≈ôen√≠ formul√°≈ôe pro proplacen√≠
    function openPaymentForm() {
      const tbody = document.getElementById('paymentTableBody');
      tbody.innerHTML = '';

      fetch(`/api/admin_zamestnanec/${selectedEmployee}`)
        .then(res => res.json())
        .then(data => {
          document.getElementById('hourlyRateInput').value = data.hourly_rate;

          const filtered = data.attendance?.filter(r => r.status.toLowerCase().includes('schv√°leno')) || [];
          for (let r of filtered) {
            tbody.innerHTML += `
              <tr>
                <td>${r.date}</td>
                <td>${r.in_time}</td>
                <td>${r.out_time}</td>
                <td>${r.hours}</td>
                <td><span class="badge-status bg-place-${(r.place || 'nezad√°no').toLowerCase()}">${r.place || '-'}</span></td>
                <td>
                  ${
                    r.note
                      ? `<a href="#" class="text-decoration-none text-dark" onclick="showFullNote(\`${r.note.replace(/`/g, '\\`')}\`); return false;">
                          <i class="bi bi-chat-left-text me-1"></i>${r.note.substring(0, 40)}${r.note.length > 40 ? '‚Ä¶' : ''}
                        </a>`
                      : '<span class="text-muted">bez pozn√°mky</span>'
                  }
                </td>
                <td class="text-center">
                  <div class="form-check d-flex justify-content-center">
                    <input class="form-check-input payment-checkbox" type="checkbox" value="${r.date}">
                  </div>
                </td>
              </tr>`;
          }

          // Spust√≠ modal
          new bootstrap.Modal(document.getElementById('paymentModal')).show();

          // P≈ôipoj√≠ obsluhy ud√°lost√≠ ‚Äì mus√≠ b√Ωt uvnit≈ô tohoto bloku!
          const toggleBtn = document.getElementById('toggleBonusBtn');
          const bonusContainer = document.getElementById('bonusHoursContainer');
          const bonusInput = document.getElementById('bonusHoursInput');
          const cancelBtn = document.getElementById('cancelBonusBtn');

          bonusHours = 0;

          toggleBtn.addEventListener('click', () => {
            toggleBtn.style.display = 'none';
            bonusContainer.style.display = 'flex';
          });

          cancelBtn.addEventListener('click', () => {
            bonusContainer.style.display = 'none';
            toggleBtn.style.display = 'inline-block';
            bonusInput.value = '';
            bonusHours = 0;
            updateTotalPayment();
          });

          bonusInput.addEventListener('input', () => {
            bonusHours = parseFloat(bonusInput.value) || 0;
            updateTotalPayment();
          });
        });
    
    }
    // Funkce pro oznaƒçen√≠ v≈°ech checkbox≈Ø Payement
    function toggleAllPaymentCheckboxes() {
      const checkboxes = document.querySelectorAll('.payment-checkbox');
      const allChecked = document.getElementById('checkAllPayments').checked;
      checkboxes.forEach(cb => cb.checked = allChecked);
    }
    // Funkce pro oznaƒçen√≠ vybran√Ωch hodin jako proplacen√©
    function paySelected() {
      const checked = [...document.querySelectorAll('.payment-checkbox:checked')]
        .map(cb => cb.value);

      const hourlyRateInput = document.getElementById('hourlyRateInput');
      const hourlyRate = hourlyRateInput ? parseFloat(hourlyRateInput.value) : NaN;

      // DEBUG v√Ωpis ‚Äì zobraz√≠ se v konzoli (F12 ‚Üí Console)
      console.log("Odes√≠l√°m platbu:", checked, "Sazba:", hourlyRate);

      // Ochrana: ≈æ√°dn√© dny nebo ≈°patn√° hodinov√° sazba
      if (!checked.length || isNaN(hourlyRate)) {
        alert("Zkontroluj v√Ωbƒõr dn≈Ø a zadanou hodinovou mzdu.");
        return;
      }
      
      // Tady to vybere jmeno
      const username = selectedEmployee;


      fetch(`/api/admin_zamestnanec_zaplaceno/${username}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          checkedIds: checked,
          hourlyRate: hourlyRate
        })
      })
      .then(res => res.json())
      .then(data => {
        console.log("Odpovƒõƒè ze serveru:", data);
        if (data.success) {
          alert('V√Ωplata byla zaps√°na!');
          bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide(); // Zav≈ôe modal
          showProfile(selectedEmployee); // Naƒçte znovu profil se v≈°emi daty
      
        } else {
          alert('Chyba: ' + (data.error || 'Nezn√°m√° chyba'));
        }
      })
      .catch(error => {
        console.error("Chyba p≈ôi fetchi:", error);
        alert("Nastala chyba p≈ôi odes√≠l√°n√≠ po≈æadavku.");
      });
    }


    // Funkce na zobrazen√≠ cel√© pozn√°mky
    function showFullNote(note) {
      document.getElementById('noteModalBody').innerText = note || '(bez pozn√°mky)';
      const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('noteModal'));
      modal.show();
    }
    
  </script>

  <!-- MODAL NA √öPRAVU -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Upravit doch√°zku</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <input type="hidden" id="editDate">
            <input type="hidden" id="editUsername">

            <div class="mb-3">
              <label for="editInTime" class="form-label">P≈ô√≠chod</label>
              <input type="time" class="form-control" id="editInTime">
            </div>

            <div class="mb-3">
              <label for="editOutTime" class="form-label">Odchod</label>
              <input type="time" class="form-control" id="editOutTime">
            </div>

            <div class="mb-3">
              <label for="editStatus" class="form-label">Stav</label>
              <select class="form-select" id="editStatus">
                <option value="ƒåek√° na schv√°len√≠">ƒåek√° na schv√°len√≠</option>
                <option value="Schv√°leno">Schv√°leno</option>
                <option value="Proplaceno">Proplaceno</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="editPlace" class="form-label">M√≠sto</label>
              <input type="text" class="form-control" id="editPlace">
            </div>

            <div class="mb-3">
              <label for="editNote" class="form-label">Pozn√°mka</label>
              <textarea class="form-control" id="editNote" rows="2"></textarea>
            </div>

            <div class="d-flex justify-content-between">
              <button type="button" class="btn btn-success" onclick="saveChanges()">Ulo≈æit zmƒõny</button>
              <button type="button" class="btn btn-danger" id="deleteRecordBtn">Smazat</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Modal pro schv√°len√≠ hodin -->
  <div class="modal fade" id="approvalModal" tabindex="-1" aria-labelledby="approvalModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="approvalModalLabel">Hodiny ke schv√°len√≠</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zav≈ô√≠t"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <div class="d-flex justify-content-end mb-2 pe-2">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="checkAllApprovals" onclick="toggleAllApprovalCheckboxes()">
                <label class="form-check-label" for="checkAllApprovals">
                  Oznaƒçit v≈°e
                </label>
              </div>
            </div>

          </div>
          <table class="table table-sm table-bordered">
            <thead>
              <tr>
                <th>Datum</th>
                <th>P≈ô√≠chod</th>
                <th>Odchod</th>
                <th>Hodin</th>
                <th>M√≠sto</th>
                <th>Pozn√°mka</th>
                <th class="text-center"> </th>
              </tr>
            </thead>
            <tbody id="approvalTableBody"></tbody>
          </table>
          <div class="text-end">
            <button class="btn btn-success" onclick="approveSelected()">Schv√°lit vybran√©</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal pro proplacen√≠ hodin -->
  <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="paymentModalLabel">Hodiny k proplacen√≠</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zav≈ô√≠t"></button>
        </div>
        <div class="modal-body">

          <div class="card mb-3">
            <div class="card-body">
              <div class="row g-3 align-items-start">
                <div class="row g-3 align-items-end">
                  <div class="col-md-3">
                    <label for="hourlyRateInput" class="form-label">Hodinov√° sazba (Kƒç/h)</label>
                    <input type="number" class="form-control" id="hourlyRateInput" value="0">
                  </div>

                  <div class="col-md-3">
                    <label for="selectedHoursInput" class="form-label">Oznaƒçen√© hodiny</label>
                    <input type="number" class="form-control" id="selectedHoursInput" value="0.00" readonly>
                  </div>

                  <div class="col-md-3">
                    <label for="bonusHoursInput" class="form-label">Hodiny nav√≠c</label>
                    <div class="d-flex align-items-center gap-2">
                      <input type="number" class="form-control form-control-sm" id="bonusHoursInput" placeholder="Hodiny nav√≠c" style="width: 120px;">
                      <button id="cancelBonusBtn" class="btn btn-sm btn-outline-danger" type="button">‚úñ</button>
                    </div>
                  </div>

                  <div class="col-md-3">
                    <label for="totalPaymentInput" class="form-label">K vyplacen√≠ (Kƒç)</label>
                    <input type="number" class="form-control fw-bold text-success" id="totalPaymentInput" value="0.00" readonly>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="d-flex justify-content-end mb-2">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="checkAllPayments" onclick="toggleAllPaymentCheckboxes()">
              <label class="form-check-label" for="checkAllPayments">
                Oznaƒçit v≈°e
              </label>
            </div>
          </div>
          <table class="table table-sm table-bordered">
            <thead>
              <tr>
                <th>Datum</th>
                <th>P≈ô√≠chod</th>
                <th>Odchod</th>
                <th>Hodin</th>
                <th>M√≠sto</th>
                <th>Pozn√°mka</th>
                <th class="text-center"> </th>
              </tr>
            </thead>
            <tbody id="paymentTableBody"></tbody>
          </table>
          
          <div class="text-end">
            <button class="btn btn-success" onclick="paySelected()">Oznaƒçit jako proplacen√©</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal na zobrazen√≠ cel√© pozn√°mky -->
  <div class="modal fade" id="noteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Cel√° pozn√°mka</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zav≈ô√≠t"></button>
        </div>
        <div class="modal-body" id="noteModalBody"></div>
      </div>
    </div>
  </div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    let bonusHours = 0;

    function updateTotalPayment() {
      const hourlyRate = parseFloat(document.getElementById('hourlyRateInput').value) || 0;
      const checkboxes = document.querySelectorAll('.payment-checkbox:checked');
      let totalHours = 0;

      checkboxes.forEach(cb => {
        const row = cb.closest('tr');
        const hours = parseFloat(row.children[3].innerText);
        totalHours += hours || 0;
      });

      const finalHours = totalHours + bonusHours;
      document.getElementById('selectedHoursInput').value = finalHours.toFixed(2);
      document.getElementById('totalPaymentInput').value = (finalHours * hourlyRate).toFixed(2);
    }

    // üîπ ZMƒöNA bonusov√Ωch hodin
    const bonusInput = document.getElementById('bonusHoursInput');
    if (bonusInput) {
      bonusInput.addEventListener('input', () => {
        bonusHours = parseFloat(bonusInput.value) || 0;
        updateTotalPayment();
      });
    }

    // üîπ Tlaƒç√≠tko ‚úñ pro zru≈°en√≠ bonusu
    const cancelBtn = document.getElementById('cancelBonusBtn');
    if (cancelBtn) {
      cancelBtn.addEventListener('click', () => {
        bonusHours = 0;
        bonusInput.value = '';
        updateTotalPayment();
      });
    }

    // üîπ Checkboxy pro v√Ωbƒõr hodin
    document.addEventListener('change', (e) => {
      if (e.target.classList.contains('payment-checkbox')) {
        updateTotalPayment();
      }
    });

    // üîπ Hodinov√° sazba ‚Äì ≈æiv√Ω p≈ôepoƒçet
    const rateInput = document.getElementById('hourlyRateInput');
    if (rateInput) {
      rateInput.addEventListener('input', updateTotalPayment);
    }
  });
</script>


</body>
</html>
